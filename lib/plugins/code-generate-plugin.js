const _=require("lodash"),generate=require("@babel/generator").default;function getTestFnPathList(e){const t=[];return e.traverse({ExpressionStatement(e){"test"===e.node.expression.callee.name&&(t.push(e),e.skip())}}),t}function getKeyByPath(e){return e?.node?.expression?.arguments[0]?.value||""}function getTestFnCode(e){return`test("${e}", () => {})`}function isTestBlock(e){return"CallExpression"===e.parent.type&&"test"===e.parent.callee.name}function judgeRealPath(e,t){e=e.node?.arguments[0];return!!e&&("CallExpression"===e.type&&e.callee.name===t)}function getExampleData(e,t){e=e.find(e=>e.key===t);return _.cloneDeep(e?.example||[])}function getExpectPathListByKey(e,t){const n=[];return e.traverse({CallExpression(e){"expect"===e.node.callee.name&&judgeRealPath(e,t)&&n.push(e)}}),n}function getExpectFnCode(e){return`expect(${e.key}(${e.input})).${e.type}(${e.result})`}function getDataByInfo(info){return{input:eval(`([${info.input}])`),result:eval(`(${info.result})`),type:info.type}}function getDataByPath(path){const node=path.node.arguments[0],resultNode=path.parentPath.parentPath.node.arguments[0];return{input:node.arguments.map(item=>eval(`(${generate(item).code})`)),result:eval(`(${generate(resultNode).code})`),type:path.parentPath.node.property.name}}function exampleComparator(e,t){return _.isEqual(getDataByPath(e),getDataByInfo(t))}module.exports=function(r,o){return{visitor:{Program(t){var e=getTestFnPathList(t);_.differenceWith(e,o.fileInfo,(e,{key:t})=>getKeyByPath(e)===t).forEach(e=>e.remove()),_.differenceWith(o.fileInfo,e,({key:e},t)=>getKeyByPath(t)===e).forEach(e=>{e=r.template.ast(getTestFnCode(e.key));t.node.body.push(e)})},ArrowFunctionExpression(t){if(!isTestBlock(t))return t.skip();const n=t.parent.arguments[0].value;var e=getExampleData(o.fileInfo,n),a=getExpectPathListByKey(t,n);_.differenceWith(a,e,(e,t)=>exampleComparator(e,t)).forEach(e=>e.find(e=>"ExpressionStatement"===e.type).remove()),_.differenceWith(e,a,(e,t)=>exampleComparator(t,e)).forEach(e=>{e=r.template.ast(getExpectFnCode({...e,key:n}));t.node.body.body.push(e)})}}}};